<!DOCTYPE html>
<html>
  <head>
    <title>My experiment</title>
    <script src="jspsych-6.3.0/jspsych.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-html-button-response.js"></script>
    <script src="jspsych-6.3.0/plugins/bouba-kiki.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-image-keyboard-response.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-audio-keyboard-response.js"></script>
    <script src="jspsych-6.3.0/plugins/jspsych-preload.js"></script>
    <link href="jspsych-6.3.0/css/jspsych.css" rel="stylesheet" type="text/css">
    <link href="rotate.css" rel="stylesheet" type="text/css">
  </head>
  <body></body>
  <script>


/* //create timeline

    */
// manually preload these files, since not on standard jspsych preload
  var audio = ['sound2/up2.wav'];
    
  var preload = {
      type: 'preload',
      auto_preload: true,  // automatic preload of stimulus files
      audio: audio,  // manual preload of other files
      images: ["img/bouba_7_L.png","img/bouba_7_L_R.png","img/bouba_7_S_R.png","img/bouba_7_S.png","img/kiki_7_L.png","img/kiki_7_L_R.png","img/kiki_7_S_R.png","img/kiki_7_S.png"]
    };


var timeline = [];
var PracArray = []
var combo_array = []
var trial_block = []
var soundArr = ["sound/lili.wav","sound/titi.wav","sound/didi.wav","sound/sisi.wav","sound/kiki.wav","sound/mimi.wav","sound/zizi.wav","sound/fifi.wav","sound/DADA.wav","sound/KAKA.wav","sound/SASA.wav","sound/MAMA.wav","sound/ZAZA.wav","sound/FAFA.wav","sound/LALA.wav","sound/TATA.wav"];
var large_soundArr = []

var boubaArr_L = ["img/bouba_7_L.png","img/bouba_7_L_R.png"];
var boubaArr_S = ["img/bouba_7_S_R.png","img/bouba_7_S.png"];
var kikiArr_L = ["img/kiki_7_L.png","img/kiki_7_L_R.png"];
var kikiArr_S = ["img/kiki_7_S_R.png","img/kiki_7_S.png"];

var bouba_reading_frame = 3
var reading_frame = 3
var bouba_three_in_row = true
var three_in_row = true

var imageArr = ["PracImgs/1.png","PracImgs/2.png","PracImgs/3.png","PracImgs/4.png","PracImgs/5.png","PracImgs/6.png","PracImgs/7.png","PracImgs/8.png"];
var Prac_soundArr = ["PracSounds/1.wav","PracSounds/2.wav","PracSounds/3.wav","PracSounds/4.wav","PracSounds/5.wav","PracSounds/6.wav","PracSounds/7.wav","PracSounds/8.wav"];
  
var NumArr = [0,1,2,3,4,5,6,7];
var leftButton = "z";
var rightButton = "m";
var w = window.innerWidth;
var h = window.innerHeight;

//PRACTICE TRIALS ARRAY GENERATION/////////////////////////////////////////////////////////////////////////////////////
for (let i = 0; i < 4; i++){
      var EightNums = jsPsych.randomization.sampleWithoutReplacement(NumArr, 8);
      for (let j = 0; j < 4; j++){
          num1 = EightNums[j*2]
          num2 = EightNums[j*2+1]
  
          //If it is less than 3 long just add randomly
        if (PracArray.length < 3){
          if (Math.random() > 0.5){
            PracArray.push({ stimulus: Prac_soundArr[num1], imageLeft:imageArr[num1], imageRight:imageArr[num2], correct_response:leftButton})
          }
          else{
            PracArray.push({ stimulus: Prac_soundArr[num1], imageLeft:imageArr[num2], imageRight:imageArr[num1], correct_response:rightButton})
          }
        }
        //If there are 3 or more entries already make sure the last 3 are not the same.
        else{

          //Get an array of the last 3 values
          lastThree = PracArray.slice(-3);
          lastThreeCorrect = [];
          for (var k=0;k<3;k++){
            lastThreeCorrect.push(lastThree[k].correct_response)
          }

          //Now check if they are all the same
          all_equal = lastThreeCorrect.every( v => v === lastThreeCorrect[0] )

          //If they are all the same and right make the next one left 
          if(all_equal && lastThreeCorrect[0] == rightButton){
            PracArray.push({ stimulus: Prac_soundArr[num1], imageLeft:imageArr[num1], imageRight:imageArr[num2], correct_response:leftButton})
          }
          //If they are all the same and left make the next one right 
          else if(all_equal && lastThreeCorrect[0] == leftButton){
            PracArray.push({ stimulus: Prac_soundArr[num1], imageLeft:imageArr[num2], imageRight:imageArr[num1], correct_response:rightButton})
          }
          //Otherwise select randomly
          else{
            if (Math.random() > 0.5){
              PracArray.push({ stimulus: Prac_soundArr[num1], imageLeft:imageArr[num1], imageRight:imageArr[num2], correct_response:leftButton})
            }
            else{
              PracArray.push({ stimulus: Prac_soundArr[num1], imageLeft:imageArr[num2], imageRight:imageArr[num1], correct_response:rightButton})
            }
          }
        }
      }
  }
  console.log(PracArray);

//PRACTICE TRIALS RUN/////////////////////////////////////////////////////////////////////////////////////

var hello3 = {
  type: "html-button-response",
  stimulus: '<div style="max-width:600px;"><p>You will hear TWO sounds. The first is to alert you that the trial is beginning. The second is the TARGET sound. PAY ATTENTION TO THE SECOND SOUND IN EACH TRIAL.</p>',
  choices: ['Continue'],
};
timeline.push(hello3);

var Practrial = {
      type: 'bouba-kiki',
      upsound: 'sound2/up2.wav',
  
      stimulus: jsPsych.timelineVariable('stimulus'),
      image:[jsPsych.timelineVariable('imageLeft'),jsPsych.timelineVariable('imageRight')],
      data: {
        width: w,
        height: h,
        left_image: [jsPsych.timelineVariable('imageLeft')],
        right_image: [jsPsych.timelineVariable('imageRight')],
        correct_response: jsPsych.timelineVariable('correct_response'),
      },
      on_finish: function(data){
          data.correct = jsPsych.pluginAPI.compareKeys(data.response, data.correct_response)
          console.log(data.correct_response);
      }
    };
 //after running the first 4 trials, run this conditional trial that checks if they've gotten 4 in a row correct yet
    var Pracif_trial = {
      timeline: [Practrial],
      conditional_function: function(){
          // get the data from the previous trial,
          // and check which key was pressed
          var count = jsPsych.data.get().last(4).filter({correct: true}).count();
          console.log(count);
          if(count >= 4){
              return false;
          } else {
              return true;
          }
      }
  }
  
  
    var Prac_test_procedure = {
      timeline: [Practrial],
      timeline_variables: PracArray.slice(0,4)
      //timeline_variables: PracArray.slice(0,4),
    };
  
    var Prac_if_test_procedure = {
      timeline: [Pracif_trial],
      timeline_variables: PracArray.slice(4),
    };
  
    var screen_size = {
      type: 'html-button-response',
      stimulus: '<p style="color: red; font-size: 20px"> Width: ' + w +' Height: ' + h  +'</p>',
      choices: ['Continue'],
    };
timeline.push(Prac_test_procedure);
timeline.push(Prac_if_test_procedure); 



//CREATING EXPERIMENTAL ARRAYS///////////////////////////////////////////////////////////////////////////
for(let x = 0; x<4; x++){
    //generating an array called combo_array with visual stimuli, B shape on one side and K shape on the other
    for (let i = 0; i<boubaArr_L.length; i++){
        var boubaArr_L = jsPsych.randomization.sampleWithoutReplacement(boubaArr_L, boubaArr_L.length);
        for (let j = 0; j<kikiArr_L.length; j++){
            combo_array.push([boubaArr_L[i],kikiArr_L[j]])
            combo_array.push([boubaArr_S[i],kikiArr_S[j]])
            combo_array.push([kikiArr_L[j], boubaArr_L[i]])
            combo_array.push([kikiArr_S[j], boubaArr_S[i]])
        }
    };
}

while (bouba_three_in_row) {
        var combo_array = jsPsych.randomization.sampleWithoutReplacement(combo_array, combo_array.length);

        bouba_three_in_row = false;

        //will return the 0th iten in each inner array, then check to see if it has 3 equal in a row
        for(y = 0; y <= combo_array.length-reading_frame; y++){
            to_read = combo_array.slice(y,y+reading_frame).map(function(x) {
                                                                            return x[0]; //returning the 0th item in i of combo_array
                                                                            });
            all_equal = to_read.every( v => v.includes("bouba")) || to_read.every( v => v.includes("kiki"));
                
                //console.log(to_read)
                //only if it has seen 2 in a row will this make three_in_row equal true, which makes the loop run again until it gets it right
            if(all_equal){
                bouba_three_in_row = true;
                }
            }
    }

console.log(combo_array);

for(j=0; j<4; j++){
    for(i = 0; i<soundArr.length; i++){
        large_soundArr.push(soundArr[i])
    }
};

console.log(large_soundArr)


while (three_in_row) {
    var large_soundArr = jsPsych.randomization.sampleWithoutReplacement(large_soundArr, large_soundArr.length);

    three_in_row = false;

    for(i = 0; i <= large_soundArr.length-reading_frame; i++){
        to_read = large_soundArr.slice(i,i+reading_frame);
        all_equal = to_read.every( v => v.includes("A")) || to_read.every( v => v.includes("i"));
        //using a capital "A" and lowercase "i" to differentiate the 2 types of sounds. includes() is case sensitive. 
            
            //console.log(to_read)
            //only if it has seen 2 in a row will this make three_in_row equal true, which makes the loop run again until it gets it right
        if(all_equal){
            three_in_row = true;
            }
        }
}

console.log(large_soundArr);

//adds each triad (1 audio stim and 2 visual stim) to the trial_block array
for (let i = 0; i<combo_array.length; i++){
    trial_block.push({ stimulus: large_soundArr[i], imageLeft:combo_array[i][0], imageRight:combo_array[i][1]})
};

console.log(trial_block);

//INSTRUCTIONS
var instruction = {
    type: 'html-button-response',
    stimulus: '<div style="max-width:600px;"><p>Instruction:</p> <p>Great job, you have finished the practice trials! Now for the experiment. <p> You will now see 2 abstract objects and hear an abstract sound. You need to pick the object that best matches the sound. Press the key on the same side as the matching shape. </p> <p>Press Z for shapes on the left and M for shapes on the right. </p> <p>If you take too long, the trial will end and you will start the next trial. Press "esc" to leave the study at any time. </p></div>',
    choices: ['Continue'],
   on_start: function() {
        // set progress bar to 0 at the start of experiment
       jsPsych.setProgressBar(0);
   }
  };
timeline.push(instruction);

//READY UP
var ready = {
  type: "html-button-response",
  stimulus: '<div style="max-width:600px;"><p>Ready to begin? Press Continue to begin the trials.</p>',
  choices: ['Continue'],
};
timeline.push(ready);

//TEST TRIALS//////////////////////////////////////////////////////////////////////////////////
var trial = {
      type: 'bouba-kiki',
      upsound: 'sound2/up2.wav',
      stimulus: jsPsych.timelineVariable('stimulus'),
      image:[jsPsych.timelineVariable('imageLeft'),jsPsych.timelineVariable('imageRight')],
      data: {
        left_image: [jsPsych.timelineVariable('imageLeft')],
        right_image: [jsPsych.timelineVariable('imageRight')],
      },
      on_finish: function() {
        // at the end of each trial, update the progress bar
        // based on the current value and the proportion to update for each trial
        var curr_progress_bar_value = jsPsych.getProgressBarCompleted();
        jsPsych.setProgressBar(curr_progress_bar_value + (1/n_trials));
        }
    }

var n_trials = 64;


var test_procedure = {
      timeline: [trial],
      timeline_variables: trial_block,
    };

timeline.push(test_procedure);

    jsPsych.init({
      timeline: timeline,
      show_progress_bar: true,
      auto_update_progress_bar: false,
       preload_audio: ["sound/lili.wav","sound/titi.wav","sound/didi.wav","sound/sisi.wav","sound/kiki.wav","sound/mimi.wav","sound/zizi.wav","sound/fifi.wav","sound/DADA.wav","sound/KAKA.wav","sound/SASA.wav","sound/MAMA.wav","sound/ZAZA.wav","sound/FAFA.wav","sound/LALA.wav","sound/TATA.wav"],
    //   preload_images: ['PracImgs/1.png', 'PracImgs/2.png'],
      on_finish: function(){
        jsPsych.data.displayData();
      }
    }); 


  </script>
</html>